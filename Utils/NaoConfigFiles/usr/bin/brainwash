#!/bin/bash
COUNTER=100 # ~ 10 seconds

# create mount point
mkdir -p /media/brainwasher

# mount usb drive
mount /dev/brainwasher /media/brainwasher

# check success
if [ $? -ne 0 ]
then
  if [ $(blkid -s TYPE -o value /dev/brainwasher) != "vfat" ]
  then
    logger -t brainwasher "ERROR: usb wrong filesystem"
  else
    logger -t brainwasher "ERROR: usb unknown mount error"
  fi
else
  cd /media/brainwasher
  # check if executable is available
  if [ -x "./startBrainwashing.sh" ]
  then
    # start the actual brainwasher
    ./startBrainwashing.sh
  else
    logger -t brainwasher "ERROR: missing brainwasher script"
  fi

  # mountpoint cleanup
  cd /
  until umount /media/brainwasher &> /dev/null
  do
    sleep 0.1
    ((COUNTER--))
    # max. "COUNTER" attempts to unmount device, otherwise force unmount and break -> prevent infinite loop
    if [ $COUNTER -le 0 ]
    then
      logger -t brainwasher "ERROR: unmounting usb"
      # play error sound
      sudo -u nao /usr/bin/paplay /usr/share/naoqi/wav/outch.wav
      # kill all process accessing mount point
      fuser -c -k /media/brainwasher &> /dev/null
      # force unmounting
      umount -f /media/brainwasher &> /dev/null
      break
    fi
  done

fi

# remove mountpoint
rmdir /media/brainwasher

logger -t brainwasher "finished"

#play something
sudo -u nao /usr/bin/paplay /home/nao/naoqi/Media/usb_stop.wav
