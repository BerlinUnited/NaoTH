#!/bin/bash

LOCK_FILE="/tmp/naoth.pid"
WORKING_DIR="/home/nao/naoqi/"
BINARY="/home/nao/bin/naoth"

case "$1" in
  start)
    if [ -f "${LOCK_FILE}" ]; then
      #still the running process?
      if kill -0 $(cat "${LOCK_FILE}") 2>/dev/null ; then
        echo "NaoTH cognition already started, use stop first"
        echo "if you are sure it is not running, remove ${LOCK_FILE}."
        exit 1
      fi
    fi
    if killall -0 "${BINARY}" 2>/dev/null ; then
      ewarn "!! Warning: naoqi is already running !!"
      ewarn "Please, stop it (killall ${bin}) before starting it again."
      return 1
    fi


    echo "starting naoth cognition process"
    cd ${WORKING_DIR}

    if [ nao = `whoami` ]; then
      nohup "${BINARY}" 2>&1 & echo $! > "${LOCK_FILE}" | logger &
    else
      su -c 'nohup "${BINARY}" 2>&1 & echo $! > "${LOCK_FILE}" | logger &' nao
    fi
    ;;
  stop)
    if [ -f "${LOCK_FILE}" ] ; then
      if kill -0 $(cat "${LOCK_FILE}") 2>/dev/null ; then
        OLDPID=`cat ${LOCK_FILE}`
        echo "killing naoth cognition processes ${OLDPID}"
        kill $(cat "${LOCK_FILE}")
    
        #waiting for naoqi to shutdown
        while kill -0 $(cat ${LOCK_FILE}) 2>/dev/null ; do
          sleep 1
        done
      fi
    fi
    ;;
  restart)
    $0 stop
    sleep 5
    $0 start
    ;;
  *)
    echo "Usage: /etc/init.d/naoth {start|stop|restart}"
    exit 1
    ;;

esac

exit 0
