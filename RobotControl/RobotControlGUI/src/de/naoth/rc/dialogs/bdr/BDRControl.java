package de.naoth.rc.dialogs.bdr;

import com.google.protobuf.InvalidProtocolBufferException;
import de.naoth.rc.RobotControl;
import de.naoth.rc.components.RemoteRobotPanel;
import de.naoth.rc.components.teamcomm.TeamCommListener;
import de.naoth.rc.components.teamcomm.TeamCommManager;
import de.naoth.rc.components.teamcomm.TeamCommMessage;
import de.naoth.rc.components.teamcomm.TeamCommUDPReceiver;
import de.naoth.rc.core.dialog.AbstractDialog;
import de.naoth.rc.core.dialog.DialogPlugin;
import de.naoth.rc.core.dialog.RCDialog;
import de.naoth.rc.core.manager.ObjectListener;
import de.naoth.rc.core.manager.SwingCommandExecutor;
import de.naoth.rc.dialogs.TeamCommViewer;
import de.naoth.rc.messages.BDRMessages.BDRControlCommand;
import de.naoth.rc.messages.BDRMessages.BDRBehaviorMode;
import de.naoth.rc.server.Command;
import de.naoth.rc.server.ConnectionStatusEvent;
import de.naoth.rc.server.ConnectionStatusListener;
import java.awt.Color;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.logging.Level;
import java.util.logging.Logger;
import net.xeoh.plugins.base.annotations.PluginImplementation;
import net.xeoh.plugins.base.annotations.injections.InjectPlugin;

/**
 *
 * @author Heinrich Mellmann
 */
public class BDRControl extends AbstractDialog implements TeamCommListener {

    @RCDialog(category = RCDialog.Category.BDR, name = "Control")
    
    @PluginImplementation
    public static class Plugin extends DialogPlugin<BDRControl> {

        @InjectPlugin
        public static RobotControl parent;
        @InjectPlugin
        public static SwingCommandExecutor commandExecutor;
        @InjectPlugin
        public static TeamCommManager teamcommManager;
        @InjectPlugin
        public static TeamCommUDPReceiver teamCommUDPReceiver;
    }//end Plugin

    private final int port = 10004;
    
    private final HashMap<String, RemoteRobotPanel> robotsMap = new HashMap<>();
    
    public BDRControl() 
    {
        initComponents();

        // dummy robot for tests
        //robotsMap.put("10.0.4.77", new RemoteRobotPanel(Plugin.parent.getMessageServer(),"10.0.4.77", new SPLMessage()));
        //updateRoboPanel();
        
        Plugin.teamcommManager.addListener(this);
        Plugin.teamCommUDPReceiver.connect(this, port);
        
        Plugin.parent.getMessageServer().addConnectionStatusListener(new ConnectionStatusListener() {
            @Override
            public void connected(ConnectionStatusEvent event) {
                bt_autonomois.setEnabled(true);
                bt_stop.setEnabled(true);
                bt_wartung.setEnabled(true);
            }

            @Override
            public void disconnected(ConnectionStatusEvent event) {
                bt_autonomois.setEnabled(false);
                bt_stop.setEnabled(false);
                bt_wartung.setEnabled(false);
            }
        });
    }
    
    @Override
    public void dispose() {
        Plugin.teamcommManager.removeListener(this);
        Plugin.teamCommUDPReceiver.disconnect(this, port);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jScrollPane2 = new javax.swing.JScrollPane();
        robotPanel = new javax.swing.JPanel();
        jToolBar1 = new javax.swing.JToolBar();
        filterTeam = new javax.swing.JToggleButton();
        teamSelectionBox = new javax.swing.JComboBox();
        controlPanel = new javax.swing.JPanel();
        bt_stop = new javax.swing.JToggleButton();
        bt_autonomois = new javax.swing.JToggleButton();
        bt_wartung = new javax.swing.JToggleButton();

        robotPanel.setLayout(new java.awt.GridLayout(2, 2, 5, 5));

        robotPanel.setLayout(new de.naoth.rc.components.WrapLayout(java.awt.FlowLayout.LEFT));

        jScrollPane2.setViewportView(robotPanel);

        jToolBar1.setFloatable(false);
        jToolBar1.setRollover(true);

        filterTeam.setText("Filter by Team");
        filterTeam.setFocusable(false);
        filterTeam.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        filterTeam.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        filterTeam.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                filterTeamActionPerformed(evt);
            }
        });
        jToolBar1.add(filterTeam);

        teamSelectionBox.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "0", "1", "2", "3", "4", "5", "6" }));
        teamSelectionBox.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                teamSelectionBoxActionPerformed(evt);
            }
        });
        jToolBar1.add(teamSelectionBox);

        controlPanel.setLayout(new java.awt.GridLayout(3, 0));

        bt_stop.setText("STOP");
        bt_stop.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                bt_stopActionPerformed(evt);
            }
        });
        controlPanel.add(bt_stop);

        bt_autonomois.setText("AUTONOMES SPIEL");
        bt_autonomois.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                bt_autonomoisActionPerformed(evt);
            }
        });
        controlPanel.add(bt_autonomois);

        bt_wartung.setText("WARTUNG");
        bt_wartung.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                bt_wartungActionPerformed(evt);
            }
        });
        controlPanel.add(bt_wartung);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jScrollPane2, javax.swing.GroupLayout.DEFAULT_SIZE, 426, Short.MAX_VALUE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(controlPanel, javax.swing.GroupLayout.PREFERRED_SIZE, 226, javax.swing.GroupLayout.PREFERRED_SIZE))
            .addComponent(jToolBar1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jToolBar1, javax.swing.GroupLayout.PREFERRED_SIZE, 25, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 0, Short.MAX_VALUE)
                    .addComponent(controlPanel, javax.swing.GroupLayout.DEFAULT_SIZE, 298, Short.MAX_VALUE)))
        );
    }// </editor-fold>//GEN-END:initComponents

    private void filterTeamActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_filterTeamActionPerformed
        updateRoboPanel();
    }//GEN-LAST:event_filterTeamActionPerformed

    private void teamSelectionBoxActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_teamSelectionBoxActionPerformed
        updateRoboPanel();
    }//GEN-LAST:event_teamSelectionBoxActionPerformed

    private void bt_stopActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_bt_stopActionPerformed
        BDRControlCommand.Builder cmd = BDRControlCommand.newBuilder();
        cmd.setBehaviorMode(BDRBehaviorMode.DO_NOTHING);
        sendBDRCommand(cmd.build());
    }//GEN-LAST:event_bt_stopActionPerformed

    private void bt_autonomoisActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_bt_autonomoisActionPerformed
        BDRControlCommand.Builder cmd = BDRControlCommand.newBuilder();
        cmd.setBehaviorMode(BDRBehaviorMode.AUTONOMOUS_PLAY);
        sendBDRCommand(cmd.build());
    }//GEN-LAST:event_bt_autonomoisActionPerformed

    private void bt_wartungActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_bt_wartungActionPerformed
        BDRControlCommand.Builder cmd = BDRControlCommand.newBuilder();
        cmd.setBehaviorMode(BDRBehaviorMode.WARTUNG);
        sendBDRCommand(cmd.build());
    }//GEN-LAST:event_bt_wartungActionPerformed

    class StatusUpdater implements ObjectListener<byte[]>
    {
        @Override
        public void newObjectReceived(byte[] object) {
            try {
                BDRControlCommand command = BDRControlCommand.parseFrom(object);
                
                if(command.hasBehaviorMode()) {
                    bt_autonomois.setEnabled(true);
                    bt_stop.setEnabled(true);
                    bt_wartung.setEnabled(true);
                    
                    bt_autonomois.setSelected(command.getBehaviorMode() == BDRBehaviorMode.AUTONOMOUS_PLAY);
                    bt_stop.setSelected(command.getBehaviorMode() == BDRBehaviorMode.DO_NOTHING);
                    bt_wartung.setSelected(command.getBehaviorMode() == BDRBehaviorMode.WARTUNG);
                }
                
            } catch (InvalidProtocolBufferException ex) {
                Logger.getLogger(TeamCommViewer.class.getName()).log(Level.SEVERE, null, ex);
            }
        }

        @Override
        public void errorOccured(String cause) {
            System.err.println(cause);
        }
    }
    
    class RemoteCommandResultHandler implements ObjectListener<byte[]> {

        @Override
        public void newObjectReceived(byte[] object) {
            if (!new String(object).isEmpty()) {
                System.out.println(new String(object));
            }
        }

        @Override
        public void errorOccured(String cause) {
            System.out.println(cause);
        }
    }
    
    private void sendBDRCommand(BDRControlCommand command) {
        
        Command cmd = new Command("Cognition:representation:set").addArg("BDRControlCommand", command.toByteArray());
        Plugin.commandExecutor.executeCommand(new ObjectListener<byte[]>() {
            @Override
            public void newObjectReceived(byte[] object) {
                System.out.println(new String(object));
                
                Command cmd = new Command("Cognition:representation:get").addArg("BDRControlCommand");
                Plugin.commandExecutor.executeCommand(new StatusUpdater(), cmd);
            }

            @Override
            public void errorOccured(String cause) {
                System.err.println(cause);
            }
        }, cmd);
        
        bt_autonomois.setEnabled(false);
        bt_stop.setEnabled(false);
        bt_wartung.setEnabled(false);
    }

    private void updateRoboPanel() {
        this.robotPanel.removeAll();

        for (Map.Entry<String, RemoteRobotPanel> msgEntry : robotsMap.entrySet()) {
            addPanel(msgEntry.getValue());
        }
        this.robotPanel.repaint();
    }
    
    private void addPanel(RemoteRobotPanel robotStatus) {
        if(!filterTeam.isSelected() || teamSelectionBox.getSelectedIndex() == robotStatus.getMessage().teamNum)
        {
            robotPanel.add(robotStatus);
            robotPanel.repaint();
        }
    }

    @Override
    public void newTeamCommMessages(List<TeamCommMessage> messages) {
        if (!messages.isEmpty()) {
            messages.forEach((m) -> {
                if (!robotsMap.containsKey(m.address)) {
                    RemoteRobotPanel p = new RemoteRobotPanel(Plugin.parent.getMessageServer(), m.address, m.message);
                    p.setChestColor(Color.BLUE);
                    robotsMap.put(m.address, p);
                    updateRoboPanel();
                } else {
                    robotsMap.get(m.address).setStatus(m.timestamp, m.message);
                }
            });
        }
    }


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JToggleButton bt_autonomois;
    private javax.swing.JToggleButton bt_stop;
    private javax.swing.JToggleButton bt_wartung;
    private javax.swing.JPanel controlPanel;
    private javax.swing.JToggleButton filterTeam;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JToolBar jToolBar1;
    private javax.swing.JPanel robotPanel;
    private javax.swing.JComboBox teamSelectionBox;
    // End of variables declaration//GEN-END:variables
}
