package de.naoth.rc.dialogs;

import com.google.protobuf.InvalidProtocolBufferException;
import de.naoth.rc.AbstractDialog;
import de.naoth.rc.DialogPlugin;
import de.naoth.rc.LogSimulator;
import de.naoth.rc.RobotControl;
import de.naoth.rc.manager.GenericManagerFactory;
import de.naoth.rc.messages.Representations;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.util.Map;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JOptionPane;
import net.xeoh.plugins.base.annotations.PluginImplementation;
import net.xeoh.plugins.base.annotations.injections.InjectPlugin;

/**
 *
 * @author Heinrich
 * @author Peter
 */
public class GroundTruthReader extends AbstractDialog {
    
      private Map<Integer, Boolean> topBall,
            bottomBall;
     private Map<Integer, Integer> topGoal,
            bottomGoal;

    
   

    @PluginImplementation
    public static class Plugin extends DialogPlugin<GroundTruthReader> {

        @InjectPlugin
        public static RobotControl parent;
        @InjectPlugin
        public static GenericManagerFactory genericManagerFactory;
        /*  @InjectPlugin
         public static Representation frameworkRepresentation;
         */
    }//end Plugin
  
    private final GroundTruthReader.LogPerceptListener logPerceptListener = new GroundTruthReader.LogPerceptListener();

    public GroundTruthReader() {

        initComponents();
        LogSimulator.LogSimulatorManager.getInstance().addListener(logPerceptListener);
     // Plugin.genericManagerFactory.getManager(getBallDataCommand).addListener(ballListener);
        //Plugin.genericManagerFactory.getManager(getBallTopDataCommand).addListener(ballTopListener);

    }

     private void openFile() {
        if (!this.jToggleButton3.isSelected()) return;
        String fileName = LogfilePlayer.getFileName();
        if (fileName.equals("")) {
            JOptionPane.showMessageDialog(null, "No opend logfile", "Error", JOptionPane.ERROR_MESSAGE);
            this.jToggleButton3.setSelected(false);
            return;
        }
        fileName = fileName.substring(0, fileName.lastIndexOf(".") + 1) + "gts";
        ObjectInputStream o;
        try {

            o = new ObjectInputStream(new FileInputStream(fileName));
            topBall = (Map<Integer, Boolean>) o.readObject();
            bottomBall = (Map<Integer, Boolean>) o.readObject();
            topGoal = (Map<Integer, Integer>) o.readObject();
            bottomGoal = (Map<Integer, Integer>) o.readObject();

        } catch (IOException ex) {
            JOptionPane.showMessageDialog(null, "No Groundtruth for this logfile", "Error", JOptionPane.ERROR_MESSAGE);
            this.jToggleButton3.setSelected(false);
        } catch (ClassNotFoundException ex) {
            Logger.getLogger(GroundTruthReader.class.getName()).log(Level.SEVERE, null, ex);
        }
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        buttonGroup1 = new javax.swing.ButtonGroup();
        buttonGroup2 = new javax.swing.ButtonGroup();
        jToggleButton3 = new javax.swing.JToggleButton();
        jScrollPane1 = new javax.swing.JScrollPane();
        jTextArea1 = new javax.swing.JTextArea();

        jToggleButton3.setText("listen");
        jToggleButton3.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jToggleButton3ActionPerformed(evt);
            }
        });

        jTextArea1.setColumns(20);
        jTextArea1.setRows(5);
        jTextArea1.setFocusable(false);
        jScrollPane1.setViewportView(jTextArea1);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jToggleButton3, javax.swing.GroupLayout.PREFERRED_SIZE, 81, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(123, 523, Short.MAX_VALUE))
            .addComponent(jScrollPane1)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jToggleButton3)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 392, Short.MAX_VALUE)
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

    private void jToggleButton3ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jToggleButton3ActionPerformed
        if (jToggleButton3.isSelected()) {           
                openFile();
        }
    }//GEN-LAST:event_jToggleButton3ActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.ButtonGroup buttonGroup1;
    private javax.swing.ButtonGroup buttonGroup2;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JTextArea jTextArea1;
    private javax.swing.JToggleButton jToggleButton3;
    // End of variables declaration//GEN-END:variables

    class LogPerceptListener implements LogSimulator.LogSimulatorActionListener {

        @Override
        public void frameChanged(LogSimulator.BlackBoard b, int frameNumber) {            
            if (!GroundTruthReader.this.jToggleButton3.isSelected()) {
                return;
            }
            try {               
                /**
                 * ************BallPercept*****************************************************
                 */
                byte[]data = b.getRepresentation("BallPercept");
                Representations.BallPercept ballPercept = Representations.BallPercept.parseFrom(data);
                Boolean ballHere = bottomBall.get(frameNumber);
                if (ballHere == null) {
                    GroundTruthReader.this.jTextArea1.append("" + frameNumber + ": missing Frame\n");
                    return;
                } else {
                    if (ballHere != ballPercept.getBallWasSeen()) {
                        if (ballHere) {
                            GroundTruthReader.this.jTextArea1.append("" + frameNumber + ": missed ball on botttomCamera\n");
                        } else {
                            GroundTruthReader.this.jTextArea1.append("" + frameNumber + ": false ball on botttomCamera\n");
                        }
                    }
                }
                /**
                 * ************BallPercept*****************************************************
                 */
                /**
                 * ************BallPerceptTop**************************************************
                 */
                data = b.getRepresentation("BallPerceptTop");
                ballPercept = Representations.BallPercept.parseFrom(data);
                ballHere = topBall.get(frameNumber);
                if (ballHere == null) {
                    GroundTruthReader.this.jTextArea1.append("" + frameNumber + ": missing Frame\n");
                    return;
                } else {
                    if (ballHere != ballPercept.getBallWasSeen()) {
                        if (ballHere) {
                            GroundTruthReader.this.jTextArea1.append("" + frameNumber + ": missed ball on topCamera\n");
                        } else {
                            GroundTruthReader.this.jTextArea1.append("" + frameNumber + ": false ball on topCamera\n");
                        }
                    }
                }
                /**
                 * ************BallPerceptTop**************************************************
                 */
                /**
                 * ************GoalPercept**************************************************
                 */
                data = b.getRepresentation("GoalPercept");
                Representations.GoalPercept goalPercept = Representations.GoalPercept.parseFrom(data);
                int postCount = goalPercept.getPostCount();
                Integer goalHere = bottomGoal.get(frameNumber);
                if (goalHere == null) {
                    GroundTruthReader.this.jTextArea1.append("" + frameNumber + ": missing Frame\n");
                    return;
                }
                if (goalHere == 0 && postCount != 0) {
                    GroundTruthReader.this.jTextArea1.append("" + frameNumber + ": missmatch goalpost seen: " + postCount
                            + " GroundTruth: 0 on bottomCamera\n");
                } else if (goalHere == 1 && postCount != 1) {
                    GroundTruthReader.this.jTextArea1.append("" + frameNumber + ": missmatch goalpost seen: " + postCount
                            + " GroundTruth: 1 on bottomCamera\n");
                } else if (goalHere == 2 && postCount != 2) {
                    GroundTruthReader.this.jTextArea1.append("" + frameNumber + ": missmatch goalpost seen: " + postCount
                            + " GroundTruth: 2 on bottomCamera\n");
                }
                /**
                 * ************GoalPercept**************************************************
                 */
                /**
                 * ************GoalPerceptTop***********************************************
                 */
                data = b.getRepresentation("GoalPerceptTop");
                Representations.GoalPercept goalPerceptTop = Representations.GoalPercept.parseFrom(data);
                postCount = goalPerceptTop.getPostCount();
                goalHere = topGoal.get(frameNumber);
                if (goalHere == null) {
                    GroundTruthReader.this.jTextArea1.append("" + frameNumber + ": missing Frame\n");
                    return;
                }
                if (goalHere == 0 && postCount != 0) {
                    GroundTruthReader.this.jTextArea1.append("" + frameNumber + ": missmatch goalpost seen: " + postCount
                            + " GroundTruth: 0 on topCamera\n");
                } else if (goalHere == 1 && postCount != 1) {
                    GroundTruthReader.this.jTextArea1.append("" + frameNumber + ": missmatch goalpost seen: " + postCount
                            + " GroundTruth: 1 on topCamera\n");
                } else if (goalHere == 2 && postCount != 2) {
                    GroundTruthReader.this.jTextArea1.append("" + frameNumber + ": missmatch goalpost seen: " + postCount
                            + " GroundTruth: 2 on topCamera\n");
                }
                /**
                 * ************GoalPerceptTop***********************************************
                 */

            } catch (InvalidProtocolBufferException ex) {
                ex.printStackTrace(System.err);
            }
        }

        @Override
        public void logfileOpened(LogSimulator.BlackBoard b, String path) {
            GroundTruthReader.this.openFile();
        }
    }

}//end class GroundTruthCreator

