/**
 * @file NaoController.cpp
 *
 * @author <a href="mailto:xu@informatik.hu-berlin.de">Xu, Yuan</a>
 * @author <a href="mailto:mellmann@informatik.hu-berlin.de">Mellmann, Heinrich</a>
 * @breief Interface for the real robot for both cognition and motion
 *
 */

#include "NaoController.h"

#include <algorithm>

using namespace std;
using namespace naoth;

NaoController::NaoController()
    :
    PlatformInterface("Nao", 10),
    theSoundHandler(NULL),
    theBroadCaster(NULL),
    theBroadCastListener(NULL),
    theDebugServer(NULL)
{
  // init shared memory
  // sensor data
  const std::string naoSensorDataPath = "/nao_sensor_data";
  // command data
  const std::string naoCommandMotorJointDataPath = "/nao_command.MotorJointData";
  const std::string naoCommandUltraSoundSendDataPath = "/nao_command.UltraSoundSendData";
  const std::string naoCommandIRSendDataPath = "/nao_command.IRSendData";
  const std::string naoCommandLEDDataPath = "/nao_command.LEDData";

  naoSensorData.open(naoSensorDataPath);

  naoCommandMotorJointData.open(naoCommandMotorJointDataPath);
  naoCommandUltraSoundSendData.open(naoCommandUltraSoundSendDataPath);
  naoCommandIRSendData.open(naoCommandIRSendDataPath);
  naoCommandLEDData.open(naoCommandLEDDataPath);
  // end init shared memory
  


  // read the theBodyID and the theBodyNickName from file "nao.info"
  const std::string naoInfoPath = Platform::getInstance().theConfigDirectory + "nao.info";
  ifstream is(naoInfoPath.c_str());
  if(!is.good())
  {
    // exit the program
    THROW(
		"is.good() failed. File 'Config/nao.info' found."
		"Hint: 'nao.info' is generated by NaoSMAL, you have to run it at least once." 
		"Do you call bin/naoth from /home/nao?"
		);
  }
  else
  {
    is >> theBodyID >> theBodyNickName;
    cout << "bodyID: " << theBodyID << endl;
    cout << "bodyNickName: " << theBodyNickName << endl;
  }

  // read the mac address of the LAN adaptor
  ifstream isEthMac("/sys/class/net/eth0/address");    
  isEthMac >> theHeadNickName;
  std::replace(theHeadNickName.begin(), theHeadNickName.end(), ':', '_');    
  cout << "headNickName: " << theHeadNickName << endl;



  /*  REGISTER IO  */
  // camera
  registerInput<Image>(*this);
  registerInput<ImageTop>(*this);
  registerInput<CurrentCameraSettings>(*this);
  registerInput<CurrentCameraSettingsTop>(*this);
  registerOutput<const CameraSettingsRequest>(*this);
  registerOutput<const CameraSettingsRequestTop>(*this);
    
  // sound
  registerOutput<const SoundPlayData>(*this);

  // gamecontroller
  registerInput<GameData>(*this);
  registerOutput<const GameReturnData>(*this);
    
  // teamcomm
  registerInput<TeamMessageDataIn>(*this);
  registerOutput<const TeamMessageDataOut>(*this);

  // debug comm
  registerInput<DebugMessageIn>(*this);
  registerOutput<const DebugMessageOut>(*this);

  // time
  registerInput<FrameInfo>(*this);

  // register sensor input
  registerInput<AccelerometerData>(*this);
  registerInput<SensorJointData>(*this);
  registerInput<FSRData>(*this);
  registerInput<GyrometerData>(*this);
  registerInput<InertialSensorData>(*this);
  registerInput<IRReceiveData>(*this);
  registerInput<ButtonData>(*this);
  registerInput<BatteryData>(*this);
  registerInput<UltraSoundReceiveData>(*this);

  // register command output
  registerOutput<const MotorJointData>(*this);
  registerOutput<const LEDData>(*this);
  registerOutput<const IRSendData>(*this);
  registerOutput<const UltraSoundSendData>(*this);


  /*  INIT DEVICES  */
  std::cout << "Init Platform" << endl;
  Platform::getInstance().init(this);

  std::cout << "Init SoundHandler" <<endl;
  //theSoundPlayer.play("penalized");
  theSoundHandler = new SoundControl();

  // create the teamcomm
  std::cout << "Init TeamComm" << endl;
  naoth::Configuration& config = naoth::Platform::getInstance().theConfiguration;
  string interfaceName = "wlan0";
  if(config.hasKey("teamcomm", "interface"))
  {
    interfaceName = config.getString("teamcomm", "interface");
  }
  int teamcomm_port = 10700; // default port
  config.get("teamcomm", "port", teamcomm_port);
  theBroadCaster = new BroadCaster(interfaceName, teamcomm_port);
  theBroadCastListener = new BroadCastListener(teamcomm_port, TEAMCOMM_MAX_MSG_SIZE);

  // start the debug server at the default debug port
  std::cout << "Init DebugServer" << endl;
  int debug_port = 5401; // default port
  config.get("network", "debug_port", debug_port);
  theDebugServer = new DebugServer();
  theDebugServer->start(static_cast<unsigned short>(debug_port), true);


  std::cout<< "Init SPLGameController"<<endl;
  theGameController = new SPLGameController();

  std::cout << "Init CameraHandler (bottom)" << std::endl;
  theBottomCameraHandler.init("/dev/video1", CameraInfo::Bottom, true);
  std::cout << "Init CameraHandler (top)" << std::endl;
  theTopCameraHandler.init("/dev/video0", CameraInfo::Bottom, false);
}

NaoController::~NaoController()
{
  delete theSoundHandler;
  delete theBroadCaster;
  delete theBroadCastListener;
  delete theGameController;
  delete theDebugServer;
}

void NaoController::setCameraSettingsInternal(const CameraSettingsRequest &data,
                        CameraInfo::CameraID camID)
{
  V4lCameraHandler& cameraHandler = camID == CameraInfo::Bottom
      ? theBottomCameraHandler : theTopCameraHandler;

  bool somethingChanged = false;
  if(cameraHandler.isRunning())
  {
    CurrentCameraSettings current;
    cameraHandler.getCameraSettings(current, data.queryCameraSettings);

    if(data.queryCameraSettings)
    {
      somethingChanged = false;
    }
    else
    {
      for(int i=0; i < CameraSettings::numOfCameraSetting; i++)
      {
        if(current.data[i] != data.data[i])
        {
          std::cout << "CameraParameter " <<
                        CameraSettings::getCameraSettingsName((CameraSettings::CameraSettingID) i)
                    << " was requested to change from " << current.data[i]
                    << " to " << data.data[i] << std::endl;
          somethingChanged = true;
//           break;
        }
      }
    }
  }
  if(somethingChanged)
  {
    std::cout << "Settting camera settings ("
              << (camID == CameraInfo::Bottom ? "bottom" : "top") << ")" << endl;
    cameraHandler.setAllCameraParams(data);
  }
}//end set CameraSettingsRequest

void NaoController::set(const CameraSettingsRequest &data)
{
  setCameraSettingsInternal(data, CameraInfo::Bottom);
}

void NaoController::set(const CameraSettingsRequestTop &data)
{
  setCameraSettingsInternal(data, CameraInfo::Top);
}

